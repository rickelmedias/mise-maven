#!/usr/bin/env bash

# global for error reporting
ASDF_MAVEN_ERROR=""

# Download Maven source from Apache, build, copy files and cleanup.
install_maven() {
    local version=$1
    local destdir=$2

    get_maven $version "$destdir"
    [[ -z $ASDF_MAVEN_ERROR ]] || return

    build_copy_cleanup $version "$destdir"
}

# Download Maven source from Apache.
# Tries Maven Central CDN first (fast, high availability), then falls back
# to Apache Archive (complete history). SNAPSHOT versions always use the
# Apache Snapshots repository.
get_maven() {
    local version=$1
    local destdir=$2

    local major=$(echo "$version" | cut -d '.' -f 1)

    # SNAPSHOT versions have their own dedicated repository
    if [[ $version == *SNAPSHOT ]]; then
        local url="https://repository.apache.org/service/local/artifact/maven/redirect?r=snapshots&g=org.apache.maven&a=apache-maven&v=$version&e=tar.gz&c=bin"
        curl -fLC - --connect-timeout 10 --max-time 60 --retry 3 --retry-delay 3 -o "$destdir/$version.tar.gz" "$url"
        if [ ! $? -eq 0 ]; then
            ASDF_MAVEN_ERROR="Could not download $url. Perhaps the version of Maven you're trying to install does not exist"
        fi
        return
    fi

    # Primary: Maven Central CDN — fast, high availability
    local cdn_url="https://repo.maven.apache.org/maven2/org/apache/maven/apache-maven/$version/apache-maven-$version-bin.tar.gz"

    # Fallback: Apache Archive — complete version history, but less reliable
    local archive_url="https://archive.apache.org/dist/maven/maven-$major/$version/binaries/apache-maven-$version-bin.tar.gz"

    if curl -fLC - --connect-timeout 10 --max-time 30 --retry 2 --retry-delay 2 -o "$destdir/$version.tar.gz" "$cdn_url"; then
        return 0
    fi

    echo "Warning: Maven Central CDN download failed. Falling back to Apache Archive..." >&2

    curl -fLC - --connect-timeout 10 --max-time 60 --retry 3 --retry-delay 3 -o "$destdir/$version.tar.gz" "$archive_url"
    if [ ! $? -eq 0 ]; then
        ASDF_MAVEN_ERROR="Could not download Maven $version. Both Maven Central CDN and Apache Archive failed"
    fi
}

# Build Maven, copy files and cleanup.
build_copy_cleanup() {
    local version=$1
    local destdir=$2

    local origin=$(pwd)
    cd "$destdir"
    {
        tar xzvf $version.tar.gz
        rm $version.tar.gz

        mv apache-maven-$version/* .
        rmdir apache-maven-$version
    }
    cd "$origin"
}

#
# MAIN
#
install_maven $ASDF_INSTALL_VERSION "$ASDF_INSTALL_PATH"

if [ -n "$ASDF_MAVEN_ERROR" ]; then
    echo "ERROR: $ASDF_MAVEN_ERROR." >/dev/stderr
    unset ASDF_MAVEN_ERROR
    exit 1
fi
